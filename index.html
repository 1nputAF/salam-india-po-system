<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Salam India PO & Production System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2, h3 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: center; }
    input, select { width: 100%; padding: 5px; box-sizing: border-box; }
    .top-info { display: flex; justify-content: space-between; }
    .btn { margin: 10px 5px; padding: 10px 20px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 4px; }
    .btn:hover { background-color: #45a049; }
    .btn-blue { background-color: #2196F3; }
    .btn-blue:hover { background-color: #0b7dda; }
    .btn-red { background-color: #f44336; }
    .btn-red:hover { background-color: #da190b; }
    .btn-purple { background-color: #9c27b0; }
    .btn-purple:hover { background-color: #7b1fa2; }
    .btn-orange { background-color: #FF9800; }
    .btn-orange:hover { background-color: #e68a00; }
    .signature { margin-top: 40px; display: flex; justify-content: space-between; }
    #vendorPOs { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 20px; background: #f9f9f9; }
    #pdfProgress { width: 100%; background-color: #ddd; margin-top: 10px; }
    #pdfProgressBar { height: 20px; background-color: #4CAF50; width: 0%; }
    .file-upload { margin: 20px 0; }
    .hidden { display: none; }
    .search-section { margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 5px; }
    .search-results { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; margin-top: 10px; padding: 10px; background: white; }
    .search-result-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
    .search-result-item:hover { background-color: #f5f5f5; }
    .barcode-container { margin-top: 5px; }
    .barcode-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
    .barcode-modal-content { background-color: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 800px; }
    .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close-modal:hover { color: black; }
    .barcode-sheet { page-break-after: always; margin-bottom: 20px; }
    .barcode-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .barcode-item { text-align: center; padding: 10px; border: 1px solid #eee; page-break-inside: avoid; }
    .barcode-svg { width: 100%; height: auto; max-height: 60px; }
    @media print {
      .no-print { display: none; }
      body { background: white; margin: 0; padding: 0; }
      .barcode-modal, .barcode-modal-content { display: block; width: 100%; max-width: 100%; margin: 0; padding: 0; box-shadow: none; position: static; background: white; }
      .barcode-sheet { margin: 0; padding: 10px; }
      .barcode-grid { margin: 0; padding: 0; grid-template-columns: repeat(4, 1fr); gap: 10px; }
      .barcode-item { border: 1px solid #ddd; padding: 5px; }
      .barcode-svg { width: 100%; height: auto; }
    }
    
    /* Production Tracking Styles */
    .tab-container { display: flex; margin-bottom: 20px; }
    .tab { padding: 10px 20px; cursor: pointer; background-color: #ddd; margin-right: 5px; }
    .tab.active { background-color: #4CAF50; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .dashboard { display: grid; grid-template-columns: 250px 1fr; gap: 20px; margin-top: 20px; }
    .sidebar { background-color: #34495e; color: white; padding: 20px; border-radius: 5px; height: fit-content; }
    .main-content { background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .nav-menu { list-style: none; padding: 0; }
    .nav-menu li { padding: 10px 0; border-bottom: 1px solid #4a6278; }
    .nav-menu li a { color: white; text-decoration: none; display: block; }
    .status-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .status-card { background-color: #f8f9fa; border-left: 4px solid #3498db; padding: 15px; border-radius: 4px; }
    .status-card h3 { margin-top: 0; color: #2c3e50; }
    .status-card .count { font-size: 24px; font-weight: bold; }
    .process-steps { display: flex; overflow-x: auto; padding: 20px 0; margin-bottom: 20px; }
    .step { min-width: 120px; text-align: center; position: relative; padding: 0 10px; }
    .step:not(:last-child)::after { content: ""; position: absolute; top: 20px; right: -10px; width: 20px; height: 2px; background-color: #95a5a6; }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; background-color: #bdc3c7; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
    .step.active .step-circle { background-color: #27ae60; }
    .step.completed .step-circle { background-color: #2ecc71; }
    .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .badge-primary { background-color: #3498db; color: white; }
    .badge-success { background-color: #2ecc71; color: white; }
    .badge-warning { background-color: #f39c12; color: white; }
    .badge-danger { background-color: #e74c3c; color: white; }
    .scan-section { background-color: #eaf2f8; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
    .progress-bar { height: 10px; background-color: #ecf0f1; border-radius: 5px; margin-bottom: 20px; overflow: hidden; }
    .progress { height: 100%; background-color: #2ecc71; width: 65%; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    
    @media (max-width: 768px) {
      .dashboard { grid-template-columns: 1fr; }
      .tab-container { flex-direction: column; }
      .tab { margin-bottom: 5px; }
    }
  </style>
</head>
<body>

<h2>SALAM INDIA</h2>

<div class="tab-container">
  <div class="tab active" onclick="switchTab('poSystem')">Purchase Order System</div>
  <div class="tab" onclick="switchTab('productionTracking')">Production Tracking</div>
</div>

<!-- Purchase Order System Tab -->
<div id="poSystem" class="tab-content active">
  <h3>Purchase Order</h3>

  <div class="file-upload">
    <input type="file" id="pdfUpload" accept=".pdf" style="display: none;">
    <button class="btn btn-blue" onclick="document.getElementById('pdfUpload').click()">üìÑ Import from PDF</button>
    <div id="pdfProgress" class="hidden">
      <div id="pdfProgressBar"></div>
    </div>
  </div>

  <div class="top-info">
    <div>
      <p><strong>PO No:</strong> <span id="poNumber"></span></p>
      <p><strong>Vendor Code:</strong> <input type="text" id="vendorCode" readonly></p>
      <button class="btn" onclick="generateVendorCode()">Generate Vendor Code</button>
      <p><strong>Delivery Code:</strong> <span id="deliveryCode"></span></p>
    </div>
    <div>
      <p><strong>Order Date:</strong> <span id="orderDate"></span></p>
      <p><strong>Delivery Date:</strong> <input type="date" id="deliveryDate"></p>
    </div>
  </div>

  <p><strong>Issued To:</strong> <input type="text" id="issuedTo" placeholder="Vendor/Client Name"></p>

  <table id="poTable">
    <thead>
      <tr>
        <th>Sr.</th>
        <th>Article Name</th>
        <th>Design Code</th>
        <th>Size</th>
        <th>Unit</th>
        <th>GSM</th>
        <th>No. of Pieces</th>
        <th>SQM</th>
        <th>Rate (‚Çπ)</th>
        <th>Amount (‚Çπ)</th>
        <th>Barcode</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="poBody"></tbody>
  </table>

  <button class="btn" onclick="addRow()">+ Add Item</button>
  <h3>Total: ‚Çπ<span id="totalAmount">0.00</span></h3>

  <div class="signature">
    <p>_____________________<br>Authorized Signatory</p>
    <p>_____________________<br>Vendor Signature</p>
  </div>

  <button class="btn" onclick="savePO()">üíæ Save PO</button>
  <button class="btn" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
  <button class="btn btn-orange no-print" onclick="generateAllBarcodes()">üñ®Ô∏è Generate & Print All Barcodes</button>
  <button class="btn btn-red" onclick="clearForm()">‚ùå Clear Form</button>

  <div class="search-section">
    <h3>üîç Search Issued POs</h3>
    <div style="display: flex; gap: 10px;">
      <input type="text" id="searchVendorName" placeholder="Search by Vendor Name">
      <input type="text" id="searchVendorCode" placeholder="Search by Vendor Code">
      <button class="btn btn-purple" onclick="searchPOs()">Search</button>
    </div>
    <div id="searchResults" class="search-results hidden"></div>
  </div>
</div>

<!-- Production Tracking Tab -->
<div id="productionTracking" class="tab-content">
  <div class="dashboard">
    <div class="sidebar">
      <ul class="nav-menu">
        <li><a href="#" onclick="showProductionSection('dashboard')">Dashboard</a></li>
        <li><a href="#" onclick="showProductionSection('poTracking')">PO Tracking</a></li>
        <li><a href="#" onclick="showProductionSection('qcReports')">QC Reports</a></li>
        <li><a href="#" onclick="showProductionSection('departmentViews')">Department Views</a></li>
        <li><a href="#" onclick="showProductionSection('bottleneck')">Bottleneck Analysis</a></li>
      </ul>
    </div>

    <div class="main-content">
      <!-- Dashboard Section -->
      <div id="productionDashboard" class="production-section">
        <h2>Production Dashboard</h2>
        <div class="status-cards">
          <div class="status-card">
            <h3>Total Carpets in Production</h3>
            <div class="count" id="totalCarpets">0</div>
          </div>
          <div class="status-card">
            <h3>Completed Today</h3>
            <div class="count" id="completedToday">0</div>
          </div>
          <div class="status-card">
            <h3>QC Passed</h3>
            <div class="count" id="qcPassed">0</div>
          </div>
          <div class="status-card">
            <h3>QC Failed</h3>
            <div class="count" id="qcFailed">0</div>
          </div>
        </div>

        <h3>Current Production Status</h3>
        <div class="process-steps">
          <div class="step completed">
            <div class="step-circle">1</div>
            <div>Weaving</div>
          </div>
          <div class="step completed">
            <div class="step-circle">2</div>
            <div>Bazar/QC</div>
          </div>
          <div class="step completed">
            <div class="step-circle">3</div>
            <div>Washing</div>
          </div>
          <div class="step active">
            <div class="step-circle">4</div>
            <div>Stretching</div>
          </div>
          <div class="step">
            <div class="step-circle">5</div>
            <div>Binding</div>
          </div>
          <div class="step">
            <div class="step-circle">6</div>
            <div>Embossing</div>
          </div>
          <div class="step">
            <div class="step-circle">7</div>
            <div>Finishing</div>
          </div>
        </div>

        <div class="scan-section">
          <h3>Update Carpet Status</h3>
          <div class="form-group">
            <label for="barcode">Scan Barcode</label>
            <input type="text" id="barcode" placeholder="Scan or enter barcode">
          </div>
          <div class="form-group">
            <label for="status">Current Status</label>
            <select id="status">
              <option value="">Select status</option>
              <option value="received">Received from Weaving</option>
              <option value="qc">In Bazar/QC</option>
              <option value="washing">In Washing</option>
              <option value="stretching">In Stretching</option>
              <option value="binding">In Binding</option>
              <option value="embossing">In Embossing</option>
              <option value="finishing">In Final Finishing</option>
              <option value="qc_passed">QC Passed</option>
              <option value="qc_failed">QC Failed</option>
              <option value="ready">Ready for Shipment</option>
            </select>
          </div>
          <div class="form-group">
            <label for="productionNotes">Notes (Optional)</label>
            <input type="text" id="productionNotes" placeholder="Add any notes">
          </div>
          <button class="btn" onclick="updateCarpetStatus()">Update Status</button>
        </div>

        <h3>Recent Activity</h3>
        <table id="productionTable">
          <thead>
            <tr>
              <th>Barcode ID</th>
              <th>PO Number</th>
              <th>Current Status</th>
              <th>Department</th>
              <th>Last Updated</th>
              <th>QC Status</th>
            </tr>
          </thead>
          <tbody id="productionBody">
            <!-- Will be populated dynamically -->
          </tbody>
        </table>
      </div>

      <!-- PO Tracking Section -->
      <div id="poTracking" class="production-section" style="display: none;">
        <h2>PO Tracking</h2>
        <div class="search-section">
          <div style="display: flex; gap: 10px;">
            <input type="text" id="searchPONumber" placeholder="Search by PO Number">
            <button class="btn btn-purple" onclick="searchProductionPOs()">Search</button>
          </div>
          <div id="poSearchResults" class="search-results hidden"></div>
        </div>
        
        <div id="poTrackingDetails" style="display: none;">
          <h3 id="trackingPONumber"></h3>
          <div class="progress-bar">
            <div class="progress" id="poProgressBar"></div>
          </div>
          <p>Completion: <span id="poCompletion">0</span>%</p>
          
          <table>
            <thead>
              <tr>
                <th>Barcode</th>
                <th>Article</th>
                <th>Design</th>
                <th>Current Status</th>
                <th>Last Updated</th>
              </tr>
            </thead>
            <tbody id="poTrackingBody">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- QC Reports Section -->
      <div id="qcReports" class="production-section" style="display: none;">
        <h2>QC Reports</h2>
        <div class="status-cards">
          <div class="status-card">
            <h3>Total QC Checks</h3>
            <div class="count" id="totalQCChecks">0</div>
          </div>
          <div class="status-card">
            <h3>Pass Rate</h3>
            <div class="count" id="qcPassRate">0%</div>
          </div>
          <div class="status-card">
            <h3>Common Issues</h3>
            <div class="count" id="commonIssues">-</div>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Barcode</th>
              <th>PO Number</th>
              <th>QC Result</th>
              <th>Date</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="qcReportBody">
            <!-- Will be populated dynamically -->
          </tbody>
        </table>
      </div>
      
      <!-- Department Views Section -->
      <div id="departmentViews" class="production-section" style="display: none;">
        <h2>Department Views</h2>
        <div class="status-cards">
          <div class="status-card" onclick="showDepartmentCarpets('Weaving Center')">
            <h3>Weaving Center</h3>
            <div class="count" id="weavingCount">0</div>
          </div>
          <div class="status-card" onclick="showDepartmentCarpets('QC Department')">
            <h3>QC Department</h3>
            <div class="count" id="qcCount">0</div>
          </div>
          <div class="status-card" onclick="showDepartmentCarpets('Washing Department')">
            <h3>Washing</h3>
            <div class="count" id="washingCount">0</div>
          </div>
          <div class="status-card" onclick="showDepartmentCarpets('Stretching Department')">
            <h3>Stretching</h3>
            <div class="count" id="stretchingCount">0</div>
          </div>
          <div class="status-card" onclick="showDepartmentCarpets('Binding Department')">
            <h3>Binding</h3>
            <div class="count" id="bindingCount">0</div>
          </div>
          <div class="status-card" onclick="showDepartmentCarpets('Embossing Department')">
            <h3>Embossing</h3>
            <div class="count" id="embossingCount">0</div>
          </div>
          <div class="status-card" onclick="showDepartmentCarpets('Finishing Department')">
            <h3>Finishing</h3>
            <div class="count" id="finishingCount">0</div>
          </div>
        </div>
        
        <div id="departmentCarpets" style="display: none; margin-top: 20px;">
          <h3 id="departmentTitle"></h3>
          <table>
            <thead>
              <tr>
                <th>Barcode</th>
                <th>PO Number</th>
                <th>Article</th>
                <th>Design</th>
                <th>Time in Dept</th>
              </tr>
            </thead>
            <tbody id="departmentCarpetsBody">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Bottleneck Analysis Section -->
      <div id="bottleneck" class="production-section" style="display: none;">
        <h2>Bottleneck Analysis</h2>
        <div class="status-cards">
          <div class="status-card">
            <h3>Avg Weaving Time</h3>
            <div class="count" id="avgWeavingTime">-</div>
          </div>
          <div class="status-card">
            <h3>Avg QC Time</h3>
            <div class="count" id="avgQCTime">-</div>
          </div>
          <div class="status-card">
            <h3>Avg Washing Time</h3>
            <div class="count" id="avgWashingTime">-</div>
          </div>
          <div class="status-card">
            <h3>Slowest Department</h3>
            <div class="count" id="slowestDept">-</div>
          </div>
        </div>
        <div style="margin-top: 20px;">
          <canvas id="timeChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Barcode Modal -->
<div id="barcodeModal" class="barcode-modal">
  <div class="barcode-modal-content">
    <span class="close-modal" onclick="closeModal()">&times;</span>
    <div id="modalContent"></div>
    <div class="no-print" style="text-align: center; margin-top: 20px;">
      <button class="btn" onclick="window.print()">Print Barcodes</button>
      <button class="btn btn-red" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<script>
  // Configure PDF.js
  pdfjsLib = window['pdfjs-dist/build/pdf'];
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

  // API Configuration - Updated to use your provided Google Apps Script URL
  const API_URL = "https://script.google.com/macros/s/AKfycbyvNZG82zqaAqcH-jPbNq9IG2mlfHiSOVYQMrpB5kgqI55hIRXmip8kp8u7Zq_wwnQL/exec";

  // Global variables
  let poCounter = 0;
  const currentYear = new Date().getFullYear().toString().slice(-2);
  let currentBarcodes = {};
  let productionData = JSON.parse(localStorage.getItem('productionData')) || { carpets: [], poStatus: {} };
  let timeChart = null;

  // Tab switching functions
  function switchTab(tabId) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
    
    if (tabId === 'productionTracking') {
      showProductionSection('dashboard');
    }
  }

  function showProductionSection(sectionId) {
    document.querySelectorAll('.production-section').forEach(section => {
      section.style.display = 'none';
    });
    document.getElementById(sectionId).style.display = 'block';
    
    // Update the specific section
    switch(sectionId) {
      case 'dashboard':
        updateProductionDashboard();
        break;
      case 'qcReports':
        updateQCReports();
        break;
      case 'departmentViews':
        updateDepartmentViews();
        break;
      case 'bottleneck':
        updateBottleneckAnalysis();
        break;
    }
  }

  // Initialize the PO form
  function initPO() {
    const today = new Date();
    document.getElementById('orderDate').innerText = formatDate(today);
    document.getElementById('deliveryCode').innerText = 'DEL-' + Math.floor(1000 + Math.random() * 9000);
    addRow();
    generatePONumber();
    loadPOCounter();
    updateProductionDashboard();
  }

  function loadPOCounter() {
    const storedCounter = localStorage.getItem('poCounter');
    if (storedCounter) {
      poCounter = parseInt(storedCounter);
    }
  }

  function savePOCounter() {
    localStorage.setItem('poCounter', poCounter.toString());
  }

  function generatePONumber() {
    poCounter++;
    savePOCounter();
    const poCount = String(poCounter).padStart(2, '0');
    document.getElementById('poNumber').innerText = `SI-${poCount}-${currentYear}`;
  }

  function generateVendorCode() {
    const vendorName = document.getElementById('issuedTo').value.trim();
    if (!vendorName) {
      alert("Please enter vendor name first");
      return;
    }
    
    const initials = vendorName.split(' ')
      .map(word => word[0])
      .join('')
      .toUpperCase()
      .substring(0, 3);
    
    const randomNum = Math.floor(100 + Math.random() * 900);
    document.getElementById('vendorCode').value = `${initials}-${randomNum}`;
  }

  function addRow(item = {}) {
    const tbody = document.getElementById('poBody');
    const row = document.createElement('tr');
    const index = tbody.children.length + 1;
    const uniqueId = `item-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
    
    row.innerHTML = `
      <td>${index}</td>
      <td><input type="text" placeholder="Article" value="${item.article || ''}"></td>
      <td><input type="text" placeholder="Design Code" value="${item.design || ''}"></td>
      <td><input type="text" placeholder="e.g. 5x8" oninput="calculate(this)" value="${item.size || ''}"></td>
      <td>
        <select onchange="calculate(this)">
          <option value="ft" ${item.unit === 'ft' ? 'selected' : ''}>ft</option>
          <option value="cm" ${item.unit === 'cm' ? 'selected' : ''}>cm</option>
          <option value="m" ${item.unit === 'm' ? 'selected' : ''}>m</option>
          <option value="mm" ${item.unit === 'mm' ? 'selected' : ''}>mm</option>
        </select>
      </td>
      <td><input type="text" placeholder="GSM" value="${item.gsm || ''}"></td>
      <td><input type="number" min="0" value="${item.pieces || 0}" oninput="calculate(this)"></td>
      <td><input type="text" readonly value="${item.sqm || ''}"></td>
      <td><input type="number" min="0" value="${item.rate || 0}" oninput="calculate(this)"></td>
      <td><input type="text" readonly value="${item.amount || ''}"></td>
      <td>
        <div class="barcode-container" id="barcode-${uniqueId}"></div>
        <button class="btn btn-blue no-print" style="padding: 5px 10px; font-size: 12px;" 
                onclick="generateBarcode('${uniqueId}')">Generate Barcode</button>
      </td>
      <td><button class="btn btn-red" onclick="deleteRow(this)">Delete</button></td>
    `;
    tbody.appendChild(row);
    
    if (Object.keys(item).length > 0) {
      calculate(row.querySelector('input[placeholder="e.g. 5x8"]'));
    }
    
    // Store item reference
    currentBarcodes[uniqueId] = {
      row: row,
      generated: false,
      barcodeData: null
    };
  }

  function generateBarcode(itemId) {
    const row = currentBarcodes[itemId].row;
    const article = row.cells[1].querySelector('input').value.trim();
    const design = row.cells[2].querySelector('input').value.trim();
    const pieces = parseInt(row.cells[6].querySelector('input').value) || 0;
    const poNumber = document.getElementById('poNumber').innerText;
    
    if (!article || !design) {
      alert("Please enter Article Name and Design Code first");
      return;
    }
    
    if (pieces === 0) {
      alert("Please enter number of pieces first");
      return;
    }
    
    // Create barcode data
    const barcodeData = `${poNumber}-${design}-${article}`;
    const container = document.getElementById(`barcode-${itemId}`);
    container.innerHTML = '';
    
    // Generate sample barcode
    JsBarcode(`#barcode-${itemId}`, `${barcodeData}-1`, {
      format: "CODE128",
      lineColor: "#000",
      width: 2,
      height: 50,
      displayValue: true,
      fontSize: 12,
      margin: 5
    });
    
    // Store barcode data
    currentBarcodes[itemId].generated = true;
    currentBarcodes[itemId].barcodeData = barcodeData;
    currentBarcodes[itemId].pieces = pieces;
    
    // Add tracking info below barcode
    const infoDiv = document.createElement('div');
    infoDiv.style.fontSize = '10px';
    infoDiv.style.marginTop = '5px';
    infoDiv.innerHTML = `PO: ${poNumber}<br>Design: ${design}<br>Article: ${article}<br>1 of ${pieces}`;
    container.appendChild(infoDiv);
  }

  function generateAllBarcodes() {
    const modal = document.getElementById('barcodeModal');
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = '<h2>Barcode Sheets</h2>';
    
    const poNumber = document.getElementById('poNumber').innerText;
    const vendorName = document.getElementById('issuedTo').value;
    
    // Create a sheet for each item
    document.querySelectorAll('#poBody tr').forEach((row, rowIndex) => {
      const article = row.cells[1].querySelector('input').value.trim();
      const design = row.cells[2].querySelector('input').value.trim();
      const pieces = parseInt(row.cells[6].querySelector('input').value) || 0;
      
      if (!article || !design || pieces === 0) return;
      
      const barcodeData = `${poNumber}-${design}-${article}`;
      const sheetDiv = document.createElement('div');
      sheetDiv.className = 'barcode-sheet';
      sheetDiv.style.pageBreakAfter = 'always';
      
      // Sheet header
      sheetDiv.innerHTML += `
        <h3>${vendorName}</h3>
        <p><strong>PO:</strong> ${poNumber} | <strong>Article:</strong> ${article} | <strong>Design:</strong> ${design} | <strong>Quantity:</strong> ${pieces}</p>
        <hr>
      `;
      
      // Create barcode grid
      let barcodeCount = 0;
      while (barcodeCount < pieces) {
        const gridDiv = document.createElement('div');
        gridDiv.className = 'barcode-grid';
        
        // Add up to 4 barcodes per row
        for (let i = 0; i < 4 && barcodeCount < pieces; i++) {
          barcodeCount++;
          const barcodeItem = document.createElement('div');
          barcodeItem.className = 'barcode-item';
          barcodeItem.style.pageBreakInside = 'avoid';
          barcodeItem.innerHTML = `
            <svg class="barcode-svg" id="barcode-sheet-${rowIndex}-${barcodeCount}"></svg>
            <div style="font-size: 10px; margin-top: 5px;">
              ${poNumber}<br>
              ${design}<br>
              ${article}<br>
              #${barcodeCount} of ${pieces}
            </div>
          `;
          gridDiv.appendChild(barcodeItem);
        }
        
        sheetDiv.appendChild(gridDiv);
      }
      
      modalContent.appendChild(sheetDiv);
    });
    
    // Show modal
    modal.style.display = 'block';
    
    // Generate all barcodes in the modal
    setTimeout(() => {
      document.querySelectorAll('#poBody tr').forEach((row, rowIndex) => {
        const article = row.cells[1].querySelector('input').value.trim();
        const design = row.cells[2].querySelector('input').value.trim();
        const pieces = parseInt(row.cells[6].querySelector('input').value) || 0;
        
        if (!article || !design || pieces === 0) return;
        
        const barcodeData = `${poNumber}-${design}-${article}`;
        
        for (let i = 1; i <= pieces; i++) {
          JsBarcode(`#barcode-sheet-${rowIndex}-${i}`, `${barcodeData}-${i}`, {
            format: "CODE128",
            lineColor: "#000",
            width: 1.5,
            height: 40,
            displayValue: false,
            margin: 5
          });
        }
      });
    }, 100);
  }

  function closeModal() {
    document.getElementById('barcodeModal').style.display = 'none';
  }

  function deleteRow(btn) {
    const row = btn.closest('tr');
    const itemId = row.querySelector('.barcode-container').id.replace('barcode-', '');
    delete currentBarcodes[itemId];
    row.remove();
    updateRowNumbers();
    updateTotal();
  }

  function updateRowNumbers() {
    const rows = document.querySelectorAll('#poBody tr');
    rows.forEach((row, index) => {
      row.cells[0].textContent = index + 1;
    });
  }

  function calculate(el) {
    const row = el.closest('tr');
    const sizeVal = row.cells[3].querySelector('input').value.trim();
    const unit = row.cells[4].querySelector('select').value;
    const pieces = parseFloat(row.cells[6].querySelector('input').value) || 0;
    const rate = parseFloat(row.cells[8].querySelector('input').value) || 0;

    let sqmPerPiece = 0;
    const sizeMatch = sizeVal.match(/^([\d.]+)\s*[xX√ó]\s*([\d.]+)$/);
    if (sizeMatch) {
      let l = parseFloat(sizeMatch[1]);
      let w = parseFloat(sizeMatch[2]);

      const area = l * w;
      switch(unit) {
        case 'ft': sqmPerPiece = area * 0.092903; break;
        case 'cm': sqmPerPiece = area / 10000; break;
        case 'mm': sqmPerPiece = area / 1000000; break;
        case 'm':  sqmPerPiece = area; break;
      }
    }

    const totalSQM = (sqmPerPiece * pieces).toFixed(2);
    row.cells[7].querySelector('input').value = totalSQM;

    const amount = (rate * totalSQM).toFixed(2);
    row.cells[9].querySelector('input').value = amount;

    updateTotal();
  }

  function updateTotal() {
    const rows = document.querySelectorAll('#poBody tr');
    let total = 0;
    rows.forEach(row => {
      const amt = parseFloat(row.cells[9].querySelector('input').value) || 0;
      total += amt;
    });
    document.getElementById('totalAmount').innerText = total.toFixed(2);
  }

  async function savePO() {
    const vendorCode = document.getElementById('vendorCode').value;
    if (!vendorCode) return alert("Vendor code is required!");

    const poData = {
      poNumber: document.getElementById('poNumber').innerText,
      vendorCode: vendorCode,
      vendorName: document.getElementById('issuedTo').value,
      deliveryDate: document.getElementById('deliveryDate').value,
      deliveryCode: document.getElementById('deliveryCode').innerText,
      issuedTo: document.getElementById('issuedTo').value,
      items: [],
      totalAmount: document.getElementById('totalAmount').innerText,
      orderDate: document.getElementById('orderDate').innerText,
      barcodes: {}
    };

    document.querySelectorAll('#poBody tr').forEach(row => {
      const tds = row.querySelectorAll('td');
      const itemId = row.querySelector('.barcode-container').id.replace('barcode-', '');
      
      poData.items.push({
        article: tds[1].querySelector('input').value,
        design: tds[2].querySelector('input').value,
        size: tds[3].querySelector('input').value,
        unit: tds[4].querySelector('select').value,
        gsm: tds[5].querySelector('input').value,
        pieces: tds[6].querySelector('input').value,
        sqm: tds[7].querySelector('input').value,
        rate: tds[8].querySelector('input').value,
        amount: tds[9].querySelector('input').value
      });
      
      if (currentBarcodes[itemId]?.generated) {
        poData.barcodes[itemId] = {
          barcodeData: currentBarcodes[itemId].barcodeData,
          pieces: currentBarcodes[itemId].pieces,
          article: tds[1].querySelector('input').value,
          design: tds[2].querySelector('input').value
        };
        
        // Add to production tracking
        addCarpetsToProduction(poData.poNumber, currentBarcodes[itemId].barcodeData, 
                              tds[1].querySelector('input').value, tds[2].querySelector('input').value,
                              currentBarcodes[itemId].pieces);
      }
    });

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: 'savePO',
          data: poData
        })
      });
      const result = await response.json();
      
      if (result.success) {
        alert(`PO ${poData.poNumber} saved successfully`);
        
        // Save to vendor-specific storage
        const vendorPOs = JSON.parse(localStorage.getItem(vendorCode)) || [];
        vendorPOs.push(poData);
        localStorage.setItem(vendorCode, JSON.stringify(vendorPOs));

        // Also save to master POs list for searching
        const allPOs = JSON.parse(localStorage.getItem('allPOs')) || [];
        allPOs.push(poData);
        localStorage.setItem('allPOs', JSON.stringify(allPOs));

        generatePONumber();
        clearForm();
        updateProductionDashboard();
      } else {
        alert(`Error: ${result.message}`);
      }
    } catch (error) {
      alert('Failed to save PO. Please check console for details.');
      console.error(error);
    }
  }

  function addCarpetsToProduction(poNumber, barcodePrefix, article, design, quantity) {
    // Initialize PO status if not exists
    if (!productionData.poStatus[poNumber]) {
      productionData.poStatus[poNumber] = {
        total: 0,
        completed: 0,
        statuses: {}
      };
    }
    
    // Add each carpet to production
    for (let i = 1; i <= quantity; i++) {
      const barcode = `${barcodePrefix}-${i}`;
      const existingCarpet = productionData.carpets.find(c => c.barcode === barcode);
      
      if (!existingCarpet) {
        productionData.carpets.push({
          barcode: barcode,
          poNumber: poNumber,
          article: article,
          design: design,
          currentStatus: "Received from Weaving",
          department: "Weaving Center",
          lastUpdated: new Date().toISOString(),
          qcStatus: "pending",
          history: [{
            fromStatus: "",
            toStatus: "Received from Weaving",
            timestamp: new Date().toISOString(),
            notes: "Added to production system"
          }]
        });
        
        // Update PO status counts
        productionData.poStatus[poNumber].total++;
        productionData.poStatus[poNumber].statuses[barcode] = "received";
      }
    }
    
    saveProductionData();
  }

  async function updateCarpetStatus() {
    const barcode = document.getElementById('barcode').value.trim();
    const status = document.getElementById('status').value;
    const notes = document.getElementById('productionNotes').value.trim();
    
    if (!barcode || !status) {
      alert("Please enter barcode and select status");
      return;
    }
    
    // Find the carpet
    const carpet = productionData.carpets.find(c => c.barcode === barcode);
    if (!carpet) {
      alert("Carpet not found in production system");
      return;
    }
    
    // Update status
    const statusMap = {
      "received": { status: "Received from Weaving", department: "Weaving Center" },
      "qc": { status: "In Bazar/QC", department: "QC Department" },
      "washing": { status: "In Washing", department: "Washing Department" },
      "stretching": { status: "In Stretching", department: "Stretching Department" },
      "binding": { status: "In Binding", department: "Binding Department" },
      "embossing": { status: "In Embossing", department: "Embossing Department" },
      "finishing": { status: "In Final Finishing", department: "Finishing Department" },
      "qc_passed": { status: "QC Passed", department: "QC Department", qcStatus: "passed" },
      "qc_failed": { status: "QC Failed", department: "QC Department", qcStatus: "failed", notes: notes || "QC Failed" },
      "ready": { status: "Ready for Shipment", department: "Shipping Department" }
    };
    
    const statusInfo = statusMap[status];
    if (!statusInfo) {
      alert("Invalid status selected");
      return;
    }

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: 'updateStatus',
          barcode: barcode,
          status: status,
          notes: notes,
          poNumber: carpet.poNumber,
          article: carpet.article,
          design: carpet.design
        })
      });
      const result = await response.json();
      
      if (result.success) {
        // Add to history
        carpet.history.push({
          fromStatus: carpet.currentStatus,
          toStatus: statusInfo.status,
          timestamp: new Date().toISOString(),
          notes: notes
        });
        
        // Update current status
        carpet.currentStatus = statusInfo.status;
        carpet.department = statusInfo.department;
        carpet.lastUpdated = new Date().toISOString();
        
        if (statusInfo.qcStatus) {
          carpet.qcStatus = statusInfo.qcStatus;
        }
        
        // Update PO status
        if (productionData.poStatus[carpet.poNumber]) {
          productionData.poStatus[carpet.poNumber].statuses[barcode] = status;
          
          if (status === "ready") {
            productionData.poStatus[carpet.poNumber].completed++;
          }
        }
        
        saveProductionData();
        updateProductionDashboard();
        
        alert(`Status updated for ${barcode} to ${statusInfo.status}`);
        document.getElementById('barcode').value = '';
        document.getElementById('status').value = '';
        document.getElementById('productionNotes').value = '';
      } else {
        alert(`Error: ${result.message}`);
      }
    } catch (error) {
      alert('Failed to update status. Please check console for details.');
      console.error(error);
    }
  }

  function saveProductionData() {
    localStorage.setItem('productionData', JSON.stringify(productionData));
  }

  function updateProductionDashboard() {
    // Update counts
    const totalCarpets = productionData.carpets.length;
    const today = new Date().toISOString().split('T')[0];
    const completedToday = productionData.carpets.filter(c => {
      return c.lastUpdated.split('T')[0] === today && c.currentStatus === "Ready for Shipment";
    }).length;
    
    const qcPassed = productionData.carpets.filter(c => c.qcStatus === "passed").length;
    const qcFailed = productionData.carpets.filter(c => c.qcStatus === "failed").length;
    
    document.getElementById('totalCarpets').textContent = totalCarpets;
    document.getElementById('completedToday').textContent = completedToday;
    document.getElementById('qcPassed').textContent = qcPassed;
    document.getElementById('qcFailed').textContent = qcFailed;
    
    // Update recent activity table
    const tbody = document.getElementById('productionBody');
    tbody.innerHTML = '';
    
    // Get last 10 updated carpets
    const recentCarpets = [...productionData.carpets]
      .sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated))
      .slice(0, 10);
    
    recentCarpets.forEach(carpet => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${carpet.barcode}</td>
        <td>${carpet.poNumber}</td>
        <td><span class="badge ${getStatusBadgeClass(carpet.currentStatus)}">${carpet.currentStatus}</span></td>
        <td>${carpet.department}</td>
        <td>${formatDate(carpet.lastUpdated)}</td>
        <td><span class="badge ${carpet.qcStatus === 'passed' ? 'badge-success' : carpet.qcStatus === 'failed' ? 'badge-danger' : 'badge-warning'}">
          ${carpet.qcStatus === 'passed' ? 'Passed' : carpet.qcStatus === 'failed' ? 'Failed' : 'Pending'}
        </span></td>
      `;
      tbody.appendChild(row);
    });
  }

  function updateQCReports() {
    const qcChecks = productionData.carpets.filter(c => c.qcStatus !== "pending");
    const totalQCChecks = qcChecks.length;
    const passedQCChecks = qcChecks.filter(c => c.qcStatus === "passed").length;
    const passRate = totalQCChecks > 0 ? Math.round((passedQCChecks / totalQCChecks) * 100) : 0;
    
    document.getElementById('totalQCChecks').textContent = totalQCChecks;
    document.getElementById('qcPassRate').textContent = `${passRate}%`;
    
    // Find common issues (simplified example)
    const failedQC = productionData.carpets.filter(c => c.qcStatus === "failed");
    const commonIssues = failedQC.length > 0 ? "Quality issues found" : "No common issues";
    document.getElementById('commonIssues').textContent = commonIssues;
    
    // Update QC report table
    const tbody = document.getElementById('qcReportBody');
    tbody.innerHTML = '';
    
    qcChecks.forEach(carpet => {
      const qcEvent = carpet.history.find(h => 
        h.toStatus === "QC Passed" || h.toStatus === "QC Failed"
      );
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${carpet.barcode}</td>
        <td>${carpet.poNumber}</td>
        <td><span class="badge ${carpet.qcStatus === 'passed' ? 'badge-success' : 'badge-danger'}">
          ${carpet.qcStatus === 'passed' ? 'Passed' : 'Failed'}
        </span></td>
        <td>${qcEvent ? formatDate(qcEvent.timestamp) : ''}</td>
        <td>${qcEvent?.notes || ''}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function updateDepartmentViews() {
    const weavingCount = productionData.carpets.filter(c => c.department === "Weaving Center").length;
    const qcCount = productionData.carpets.filter(c => c.department === "QC Department").length;
    const washingCount = productionData.carpets.filter(c => c.department === "Washing Department").length;
    const stretchingCount = productionData.carpets.filter(c => c.department === "Stretching Department").length;
    const bindingCount = productionData.carpets.filter(c => c.department === "Binding Department").length;
    const embossingCount = productionData.carpets.filter(c => c.department === "Embossing Department").length;
    const finishingCount = productionData.carpets.filter(c => c.department === "Finishing Department").length;
    
    document.getElementById('weavingCount').textContent = weavingCount;
    document.getElementById('qcCount').textContent = qcCount;
    document.getElementById('washingCount').textContent = washingCount;
    document.getElementById('stretchingCount').textContent = stretchingCount;
    document.getElementById('bindingCount').textContent = bindingCount;
    document.getElementById('embossingCount').textContent = embossingCount;
    document.getElementById('finishingCount').textContent = finishingCount;
  }

  function showDepartmentCarpets(department) {
    document.getElementById('departmentTitle').textContent = `Carpets in ${department}`;
    document.getElementById('departmentCarpets').style.display = 'block';
    
    const departmentCarpets = productionData.carpets.filter(c => c.department === department);
    const tbody = document.getElementById('departmentCarpetsBody');
    tbody.innerHTML = '';
    
    departmentCarpets.forEach(carpet => {
      const timeInDept = getTimeInDepartment(carpet);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${carpet.barcode}</td>
        <td>${carpet.poNumber}</td>
        <td>${carpet.article}</td>
        <td>${carpet.design}</td>
        <td>${timeInDept}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function getTimeInDepartment(carpet) {
    const lastEvent = carpet.history[carpet.history.length - 1];
    if (!lastEvent) return "-";
    
    const enteredTime = new Date(lastEvent.timestamp);
    const now = new Date();
    const diffHours = Math.floor((now - enteredTime) / (1000 * 60 * 60));
    
    if (diffHours < 1) {
      const diffMinutes = Math.floor((now - enteredTime) / (1000 * 60));
      return `${diffMinutes} min`;
    } else if (diffHours < 24) {
      return `${diffHours} hours`;
    } else {
      const diffDays = Math.floor(diffHours / 24);
      return `${diffDays} days`;
    }
  }

  function updateBottleneckAnalysis() {
    // Calculate average times (simplified example)
    const weavingTimes = calculateDepartmentTimes("Weaving Center", "QC Department");
    const qcTimes = calculateDepartmentTimes("QC Department", "Washing Department");
    const washingTimes = calculateDepartmentTimes("Washing Department", "Stretching Department");
    
    const avgWeavingTime = weavingTimes.length > 0 
      ? Math.round(weavingTimes.reduce((a, b) => a + b, 0) / weavingTimes.length) 
      : 0;
    const avgQCTime = qcTimes.length > 0 
      ? Math.round(qcTimes.reduce((a, b) => a + b, 0) / qcTimes.length) 
      : 0;
    const avgWashingTime = washingTimes.length > 0 
      ? Math.round(washingTimes.reduce((a, b) => a + b, 0) / washingTimes.length) 
      : 0;
    
    document.getElementById('avgWeavingTime').textContent = `${avgWeavingTime} hrs`;
    document.getElementById('avgQCTime').textContent = `${avgQCTime} hrs`;
    document.getElementById('avgWashingTime').textContent = `${avgWashingTime} hrs`;
    
    // Find slowest department
    const times = {
      "Weaving": avgWeavingTime,
      "QC": avgQCTime,
      "Washing": avgWashingTime
    };
    
    let slowestDept = "-";
    let maxTime = 0;
    for (const [dept, time] of Object.entries(times)) {
      if (time > maxTime) {
        maxTime = time;
        slowestDept = dept;
      }
    }
    
    document.getElementById('slowestDept').textContent = slowestDept;
    
    // Create chart
    createTimeChart(times);
  }

  function calculateDepartmentTimes(fromDept, toDept) {
    const times = [];
    
    productionData.carpets.forEach(carpet => {
      const enteredFrom = carpet.history.find(h => 
        h.toStatus.includes(fromDept.replace(" Department", ""))
      );
      const enteredTo = carpet.history.find(h => 
        h.toStatus.includes(toDept.replace(" Department", ""))
      );
      
      if (enteredFrom && enteredTo) {
        const timeDiff = (new Date(enteredTo.timestamp) - new Date(enteredFrom.timestamp));
        const hours = Math.round(timeDiff / (1000 * 60 * 60));
        times.push(hours);
      }
    });
    
    return times;
  }

  function createTimeChart(times) {
    const ctx = document.getElementById('timeChart').getContext('2d');
    
    // Destroy previous chart if exists
    if (timeChart) {
      timeChart.destroy();
    }
    
    timeChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(times),
        datasets: [{
          label: 'Average Processing Time (hours)',
          data: Object.values(times),
          backgroundColor: [
            'rgba(255, 99, 132, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 206, 86, 0.2)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  function getStatusBadgeClass(status) {
    switch(status) {
      case "Ready for Shipment": return "badge-success";
      case "QC Passed": return "badge-success";
      case "QC Failed": return "badge-danger";
      default: return "badge-primary";
    }
  }

  function searchPOs() {
    const vendorName = document.getElementById('searchVendorName').value.toLowerCase();
    const vendorCode = document.getElementById('searchVendorCode').value.toUpperCase();
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '';
    
    if (!vendorName && !vendorCode) {
      resultsDiv.innerHTML = 'Please enter vendor name or code to search';
      resultsDiv.classList.remove('hidden');
      return;
    }

    const allPOs = JSON.parse(localStorage.getItem('allPOs')) || [];
    const filteredPOs = allPOs.filter(po => {
      const nameMatch = vendorName ? po.vendorName.toLowerCase().includes(vendorName) : true;
      const codeMatch = vendorCode ? po.vendorCode.toUpperCase().includes(vendorCode) : true;
      return nameMatch && codeMatch;
    });

    if (filteredPOs.length === 0) {
      resultsDiv.innerHTML = 'No matching POs found';
      resultsDiv.classList.remove('hidden');
      return;
    }

    filteredPOs.forEach(po => {
      const poDiv = document.createElement('div');
      poDiv.className = 'search-result-item';
      poDiv.innerHTML = `
        <strong>PO: ${po.poNumber}</strong> | Vendor: ${po.vendorName} (${po.vendorCode})<br>
        Date: ${po.orderDate} | Total: ‚Çπ${po.totalAmount}<br>
        <button class="btn btn-blue" style="padding: 5px 10px; font-size: 12px;" 
                onclick="viewPODetails('${po.poNumber}')">View Details</button>
        <button class="btn" style="padding: 5px 10px; font-size: 12px;" 
                onclick="reusePO('${po.poNumber}')">Reuse PO</button>
        <button class="btn btn-orange" style="padding: 5px 10px; font-size: 12px;" 
                onclick="viewBarcodes('${po.poNumber}')">View Barcodes</button>
      `;
      resultsDiv.appendChild(poDiv);
    });

    resultsDiv.classList.remove('hidden');
  }

  function searchProductionPOs() {
    const poNumber = document.getElementById('searchPONumber').value.trim();
    const resultsDiv = document.getElementById('poSearchResults');
    resultsDiv.innerHTML = '';
    
    if (!poNumber) {
      resultsDiv.innerHTML = 'Please enter PO number to search';
      resultsDiv.classList.remove('hidden');
      return;
    }

    const allPOs = JSON.parse(localStorage.getItem('allPOs')) || [];
    const filteredPOs = allPOs.filter(po => po.poNumber.includes(poNumber));

    if (filteredPOs.length === 0) {
      resultsDiv.innerHTML = 'No matching POs found';
      resultsDiv.classList.remove('hidden');
      return;
    }

    filteredPOs.forEach(po => {
      const poDiv = document.createElement('div');
      poDiv.className = 'search-result-item';
      poDiv.innerHTML = `
        <strong>PO: ${po.poNumber}</strong> | Vendor: ${po.vendorName} (${po.vendorCode})<br>
        Date: ${po.orderDate} | Total: ‚Çπ${po.totalAmount}<br>
        <button class="btn btn-blue" style="padding: 5px 10px; font-size: 12px;" 
                onclick="showPOTracking('${po.poNumber}')">Track Production</button>
      `;
      resultsDiv.appendChild(poDiv);
    });

    resultsDiv.classList.remove('hidden');
  }

  function showPOTracking(poNumber) {
    document.getElementById('poSearchResults').classList.add('hidden');
    document.getElementById('poTrackingDetails').style.display = 'block';
    document.getElementById('trackingPONumber').textContent = `Tracking Production for PO: ${poNumber}`;
    
    const poStatus = productionData.poStatus[poNumber] || { total: 0, completed: 0, statuses: {} };
    const completionPercentage = poStatus.total > 0 ? Math.round((poStatus.completed / poStatus.total) * 100) : 0;
    
    document.getElementById('poCompletion').textContent = completionPercentage;
    document.getElementById('poProgressBar').style.width = `${completionPercentage}%`;
    
    // Get carpets for this PO
    const poCarpets = productionData.carpets.filter(c => c.poNumber === poNumber);
    const tbody = document.getElementById('poTrackingBody');
    tbody.innerHTML = '';
    
    poCarpets.forEach(carpet => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${carpet.barcode}</td>
        <td>${carpet.article}</td>
        <td>${carpet.design}</td>
        <td><span class="badge ${getStatusBadgeClass(carpet.currentStatus)}">${carpet.currentStatus}</span></td>
        <td>${formatDate(carpet.lastUpdated)}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function viewPODetails(poNumber) {
    const allPOs = JSON.parse(localStorage.getItem('allPOs')) || [];
    const po = allPOs.find(p => p.poNumber === poNumber);
    if (!po) return;

    const details = `
      PO Number: ${po.poNumber}
      Vendor: ${po.vendorName} (${po.vendorCode})
      Order Date: ${po.orderDate}
      Delivery Date: ${po.deliveryDate}
      Total Amount: ‚Çπ${po.totalAmount}
      
      Items:
      ${po.items.map(item => `
        - ${item.article} | ${item.design} | ${item.size} ${item.unit}
          ${item.pieces} pcs | ${item.sqm} sqm | ‚Çπ${item.rate}/sqm | ‚Çπ${item.amount}
      `).join('')}
    `;

    alert(details);
  }

  function viewBarcodes(poNumber) {
    const allPOs = JSON.parse(localStorage.getItem('allPOs')) || [];
    const po = allPOs.find(p => p.poNumber === poNumber);
    if (!po) return;

    const modal = document.getElementById('barcodeModal');
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = '<h2>Barcode Sheets for PO: ' + poNumber + '</h2>';
    
    // Create a sheet for each item
    po.items.forEach((item, itemIndex) => {
      const pieces = parseInt(item.pieces) || 0;
      if (pieces === 0) return;
      
      const barcodeData = `${po.poNumber}-${item.design}-${item.article}`;
      const sheetDiv = document.createElement('div');
      sheetDiv.className = 'barcode-sheet';
      sheetDiv.style.pageBreakAfter = 'always';
      
      // Sheet header
      sheetDiv.innerHTML += `
        <h3>${po.vendorName}</h3>
        <p><strong>PO:</strong> ${po.poNumber} | <strong>Article:</strong> ${item.article} | <strong>Design:</strong> ${item.design} | <strong>Quantity:</strong> ${pieces}</p>
        <hr>
      `;
      
      // Create barcode grid
      let barcodeCount = 0;
      while (barcodeCount < pieces) {
        const gridDiv = document.createElement('div');
        gridDiv.className = 'barcode-grid';
        
        // Add up to 4 barcodes per row
        for (let i = 0; i < 4 && barcodeCount < pieces; i++) {
          barcodeCount++;
          const barcodeItem = document.createElement('div');
          barcodeItem.className = 'barcode-item';
          barcodeItem.style.pageBreakInside = 'avoid';
          barcodeItem.innerHTML = `
            <svg class="barcode-svg" id="barcode-view-${itemIndex}-${barcodeCount}"></svg>
            <div style="font-size: 10px; margin-top: 5px;">
              ${po.poNumber}<br>
              ${item.design}<br>
              ${item.article}<br>
              #${barcodeCount} of ${pieces}
            </div>
          `;
          gridDiv.appendChild(barcodeItem);
        }
        
        sheetDiv.appendChild(gridDiv);
      }
      
      modalContent.appendChild(sheetDiv);
    });
    
    // Show modal
    modal.style.display = 'block';
    
    // Generate all barcodes in the modal
    setTimeout(() => {
      po.items.forEach((item, itemIndex) => {
        const pieces = parseInt(item.pieces) || 0;
        if (pieces === 0) return;
        
        const barcodeData = `${po.poNumber}-${item.design}-${item.article}`;
        
        for (let i = 1; i <= pieces; i++) {
          JsBarcode(`#barcode-view-${itemIndex}-${i}`, `${barcodeData}-${i}`, {
            format: "CODE128",
            lineColor: "#000",
            width: 1.5,
            height: 40,
            displayValue: false,
            margin: 5
          });
        }
      });
    }, 100);
  }

  function reusePO(poNumber) {
    const allPOs = JSON.parse(localStorage.getItem('allPOs')) || [];
    const po = allPOs.find(p => p.poNumber === poNumber);
    if (!po) return;

    if (confirm(`Create new PO based on ${po.poNumber} for ${po.vendorName}?`)) {
      clearForm();
      document.getElementById('issuedTo').value = po.vendorName;
      document.getElementById('vendorCode').value = po.vendorCode;
      
      po.items.forEach(item => {
        addRow(item);
      });
      
      updateTotal();
      generatePONumber();
    }
  }

  function clearForm() {
    if (confirm("Are you sure you want to clear the form? All unsaved data will be lost.")) {
      document.getElementById('poBody').innerHTML = '';
      document.getElementById('issuedTo').value = '';
      document.getElementById('deliveryDate').value = '';
      document.getElementById('totalAmount').innerText = '0.00';
      document.getElementById('vendorCode').value = '';
      currentBarcodes = {};
      initPO();
    }
  }

  // PDF Import Functionality
  document.getElementById('pdfUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const progress = document.getElementById('pdfProgress');
    const progressBar = document.getElementById('pdfProgressBar');
    progress.classList.remove('hidden');
    progressBar.style.width = '0%';

    const reader = new FileReader();
    reader.onload = function() {
      const typedarray = new Uint8Array(this.result);
      
      pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
        let totalPages = pdf.numPages;
        let pagesProcessed = 0;
        let fullText = '';
        
        for (let i = 1; i <= totalPages; i++) {
          pdf.getPage(i).then(function(page) {
            return page.getTextContent();
          }).then(function(textContent) {
            pagesProcessed++;
            fullText += textContent.items.map(item => item.str).join(' ');
            progressBar.style.width = `${(pagesProcessed / totalPages) * 100}%`;
            
            if (pagesProcessed === totalPages) {
              processPDFText(fullText);
              progress.classList.add('hidden');
            }
          });
        }
      }).catch(function(error) {
        alert('Error processing PDF: ' + error.message);
        progress.classList.add('hidden');
      });
    };
    reader.readAsArrayBuffer(file);
  });

  function processPDFText(text) {
    const vendorMatch = text.match(/(?:Vendor|Client|Supplier)[:\s]+([^\n]+)/i);
    if (vendorMatch) {
      document.getElementById('issuedTo').value = vendorMatch[1].trim();
    }
    
    const poMatch = text.match(/(?:PO|Order|Purchase Order)[\s#:]+([A-Z0-9-]+)/i);
    if (poMatch) {
      document.getElementById('poNumber').innerText = poMatch[1].trim();
    }
    
    const dateMatch = text.match(/(?:Delivery|Dispatch|Ship)[\s]+(?:Date|on)[:\s]+([0-9\/-]+)/i);
    if (dateMatch) {
      document.getElementById('deliveryDate').value = formatDateForInput(dateMatch[1].trim());
    }
    
    const itemRegex = /([A-Za-z0-9\s]+)\s+([A-Z0-9]+)\s+([\d.]+[xX√ó][\d.]+)\s+(\w+)\s+(\d+)\s+([\d.]+)\s+([\d.]+)/g;
    let match;
    let itemsFound = 0;
    
    const tbody = document.getElementById('poBody');
    while (tbody.rows.length > 1) {
      tbody.deleteRow(1);
    }
    
    while ((match = itemRegex.exec(text)) !== null) {
      itemsFound++;
      const item = {
        article: match[1].trim(),
        design: match[2].trim(),
        size: match[3].trim(),
        unit: match[4].trim(),
        pieces: match[5].trim(),
        rate: match[6].trim(),
        amount: match[7].trim()
      };
      
      if (itemsFound === 1) {
        const firstRow = tbody.rows[0];
        firstRow.cells[1].querySelector('input').value = item.article;
        firstRow.cells[2].querySelector('input').value = item.design;
        firstRow.cells[3].querySelector('input').value = item.size;
        firstRow.cells[4].querySelector('select').value = item.unit;
        firstRow.cells[6].querySelector('input').value = item.pieces;
        firstRow.cells[8].querySelector('input').value = item.rate;
        calculate(firstRow.cells[3].querySelector('input'));
      } else {
        addRow(item);
      }
    }
    
    if (itemsFound > 0) {
      alert(`Successfully imported ${itemsFound} items from PDF`);
    } else {
      alert("Could not automatically extract items from PDF. Please check the format or enter manually.");
    }
  }

  function formatDateForInput(dateStr) {
    const formats = [
      /(\d{2})\/(\d{2})\/(\d{4})/,
      /(\d{4})-(\d{2})-(\d{2})/,
      /(\d{2})-(\d{2})-(\d{4})/
    ];
    
    for (const format of formats) {
      const match = dateStr.match(format);
      if (match) {
        if (format === formats[0]) {
          return `${match[3]}-${match[2]}-${match[1]}`;
        } else if (format === formats[1]) {
          return dateStr;
        } else if (format === formats[2]) {
          return `${match[3]}-${match[2]}-${match[1]}`;
        }
      }
    }
    
    return '';
  }

  function formatDate(date) {
    if (!date) return '';
    const d = new Date(date);
    return isNaN(d.getTime()) ? date : `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('barcodeModal');
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  }

  // Initialize the PO form
  initPO();
</script>

</body>
</html>
